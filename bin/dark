#!/bin/bash

# Cannot be run on Linux
case "$OSTYPE" in
linux*)
	echo "ERROR: Script does not support Linux!"
	exit 1
	;;
esac

################################# change macOS theme

osascript -e '
	tell application "System Events"
		tell appearance preferences
			set dark mode to not dark mode
		end tell
	end tell
'

################################# variable for other apps

# define variable if need to set dark theme in other apps
# 2>/dev/null to suppress error if dark mode is off
if [[ $(defaults read -g AppleInterfaceStyle 2>/dev/null) == "Dark" ]]; then
	set_dark=true
fi

################################# Marta

conf=$HOME/Library/Application\ Support/org.yanex.marta/conf.marco

if [ "$set_dark" = true ]; then
	sed -i '' -e 's/theme "Classic"/theme "Igor"/g' "$conf"
else
	sed -i '' -e 's/theme "Igor"/theme "Classic"/g' "$conf"
fi

################################# PDF Expert

if [[ $(pgrep "PDF Expert") ]]; then
	if [ "$set_dark" = true ]; then
		osascript -e '
    		tell application "PDF Expert" to activate
				tell application "System Events"
					keystroke "n" using {option down, command down}
				end tell
			'
	else
		osascript -e '
    		tell application "PDF Expert" to activate
				tell application "System Events"
					keystroke "z" using {option down, command down}
				end tell
			'
	fi
fi

################################# JetBrains IDEs

# Uses a hacky approach with sending keystrokes from AppleScript
# Will only work if IDEs are already running

ides=("pycharm" "intellij")

for ide in "${ides[@]}"; do
	if [[ $(pgrep $ide) ]]; then
		if [ "$set_dark" = true ]; then
			osascript <<EOF
		  tell application "$ide" to activate
			tell application "System Events"
				keystroke "\`" using {control down}
				keystroke "5"
				delay 0.4
				keystroke "4"
			end tell
EOF
		else
			osascript <<EOF
		  tell application "$ide" to activate
			tell application "System Events"
				keystroke "\`" using {control down}
				keystroke "5"
				delay 0.4
				keystroke "1"
				delay 0.4
				keystroke "\`" using {control down}
				keystroke "1"
				delay 0.6
				keystroke "3"
			end tell
EOF
		fi
	fi
done

################################# VSCode

json=$HOME/Library/Application\ Support/Code/User/settings.json

if [ "$set_dark" = true ]; then
	# Night Owl Light -> Nord
	sed -i '' 's/"workbench.colorTheme": "Night Owl Light (No Italics)"/"workbench.colorTheme": "Nord"/g' "$json"
	# Colours for bracket highlighting
	sed -i '' 's/"#0c969b", "#4876d6", "#994cc3"/"#83A2C2", "#91BDBC", "#b48ead"/g' "$json"
	# To do highlighting
	sed -i '' 's/#d6438a/#b48eae/g' "$json"
	sed -i '' 's/"opacity": "10"/"opacity": "20"/g' "$json"
	# git graph
	sed -i '' 's/#de3d3b/#bf616a/g' "$json"
	sed -i '' 's/#08916a/#a3be8c/g' "$json"
	sed -i '' 's/#E0AF02/#ebcb8b/g' "$json"
	sed -i '' 's/#288ed7/#81a1c1/g' "$json"
	sed -i '' 's/#d6438a/#b48ead/g' "$json"
	sed -i '' 's/#49d0c5/#88c0d0/g' "$json"
	sed -i '' 's/#994cc3/#e5e9f0/g' "$json"
	sed -i '' 's/#403f53/#4c566a/g' "$json"
	# matching tags underline
	sed -i '' 's/"underline": "#0c969b"/"underline": "#b58faf"/g' "$json"
else
	# Nord -> Night Owl Light
	sed -i '' 's/"workbench.colorTheme": "Nord"/"workbench.colorTheme": "Night Owl Light (No Italics)"/g' "$json"
	# Colours for bracket highlighting
	sed -i '' 's/"#83A2C2", "#91BDBC", "#b48ead"/"#0c969b", "#4876d6", "#994cc3"/g' "$json"
	# To do highlighting
	sed -i '' 's/#b48eae/#d6438a/g' "$json"
	sed -i '' 's/"opacity": "20"/"opacity": "10"/g' "$json"
	# git graph
	sed -i '' 's/#bf616a/#de3d3b/g' "$json"
	sed -i '' 's/#a3be8c/#08916a/g' "$json"
	sed -i '' 's/#ebcb8b/#E0AF02/g' "$json"
	sed -i '' 's/#81a1c1/#288ed7/g' "$json"
	sed -i '' 's/#b48ead/#d6438a/g' "$json"
	sed -i '' 's/#88c0d0/#49d0c5/g' "$json"
	sed -i '' 's/#e5e9f0/#994cc3/g' "$json"
	sed -i '' 's/#4c566a/#403f53/g' "$json"
	# matching tags underline
	sed -i '' 's/"underline": "#b58faf"/"underline": "#0c969b"/g' "$json"
fi

################################# Sublime Merge

sett=$HOME/Library/Application\ Support/Sublime\ Merge/Packages/User/Preferences.sublime-settings

if [ "$set_dark" = true ]; then
	sed -i '' 's/Merge.sublime-theme/Merge Dark.sublime-theme/g' "$sett"
else
	sed -i '' 's/Merge Dark.sublime-theme/Merge.sublime-theme/g' "$sett"
fi

################################# cht.sh

conf=$HOME/.cht.sh/cht.sh.conf

if [ "$set_dark" = true ]; then
	sed -i '' 's/style=lovelace/style=paraiso-dark/g' $conf
else
	sed -i '' 's/style=paraiso-dark/style=lovelace/g' $conf
fi
