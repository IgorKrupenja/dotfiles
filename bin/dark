#!/bin/bash

# Cannot be run on Linux
case "$OSTYPE" in
linux*)
	echo "ERROR: Script does not support Linux!"
	exit 1
	;;
esac

################################# change macOS theme

osascript -e '
	tell application "System Events"
		tell appearance preferences
			set dark mode to not dark mode
		end tell
	end tell
'

################################# variable for other apps

# define variable if need to set dark theme in other apps
# 2>/dev/null to suppress error if dark mode is off
if defaults read -g AppleInterfaceStyle 2>/dev/null | grep -q "Dark"; then
	set_dark=true
fi

################################# Marta

conf=$HOME/Library/Application\ Support/org.yanex.marta/conf.marco

if [ "$set_dark" = true ]; then
	sed -i '' -e 's/theme "Classic"/theme "Igor"/g' "$conf"
else
	sed -i '' -e 's/theme "Igor"/theme "Classic"/g' "$conf"
fi

################################# PDF Expert

if [ "$set_dark" = true ]; then
	osascript -e '
		if application "PDF Expert" is running then
    		tell application "PDF Expert" to activate
			tell application "System Events"
				keystroke "n" using {option down, command down}
			end tell
		end if
		'
else
	osascript -e '
		if application "PDF Expert" is running then
    		tell application "PDF Expert" to activate
			tell application "System Events"
				keystroke "z" using {option down, command down}
			end tell
		end if
		'
fi

################################# JetBrains IDEs

# Uses a hacky approach with sending keystrokes from AppleScript
# Will only work if IDEs are already running

ides=("IntelliJ IDEA" "PyCharm")

for ide in "${ides[@]}"; do
	if [ "$set_dark" = true ]; then
		osascript <<EOF
		if application "$ide" is running then
		  tell application "$ide" to activate
			tell application "System Events"
				keystroke "\`" using {control down}
				keystroke "5"
				delay 0.4
				keystroke "4"
			end tell
		end if
EOF
	else
		osascript <<EOF
		if application "$ide" is running then
		  tell application "$ide" to activate
			tell application "System Events"
				keystroke "\`" using {control down}
				keystroke "5"
				delay 0.4
				keystroke "1"
				delay 0.4
				keystroke "\`" using {control down}
				keystroke "1"
				delay 0.4
				keystroke "9"
			end tell
		end if
EOF
	fi
done

################################# VSCode

json=$HOME/Library/Application\ Support/Code/User/settings.json

if [ "$set_dark" = true ]; then
	# theme
	sed -i '' 's/"workbench.colorTheme": "Flat White"/"workbench.colorTheme": "Material Theme Darker"/g' "$json"
	# Colours for bracket highlighting
	sed -i '' 's/#55b4d4/#82AAFF/g' "$json"
	sed -i '' 's/#f2ae49/#C792EA/g' "$json"
	sed -i '' 's/#a37acc/#F78C6C/g' "$json"
	# To do highlighting
	sed -i '' 's/#a37acc/#f08c66/g' "$json"
	# LaTeX PDF preview
	sed -i '' 's/"latex-workshop.view.pdf.invert": 0,/"latex-workshop.view.pdf.invert": 0.9,/g' "$json"
else
	# theme
	sed -i '' 's/"workbench.colorTheme": "Material Theme Darker"/"workbench.colorTheme": "Flat White"/g' "$json"
	# Colours for bracket highlighting
	sed -i '' 's/#82AAFF/#55b4d4/g' "$json"
	sed -i '' 's/#C792EA/#f2ae49/g' "$json"
	sed -i '' 's/#F78C6C/#a37acc/g' "$json"
	# To do highlighting
	sed -i '' 's/#f08c66/#a37acc/g' "$json"
	# LaTeX PDF preview
	sed -i '' 's/"latex-workshop.view.pdf.invert": 0.9,/"latex-workshop.view.pdf.invert": 0,/g' "$json"
fi

################################# Sublime Merge

sett=$HOME/Library/Application\ Support/Sublime\ Merge/Packages/User/Preferences.sublime-settings

if [ "$set_dark" = true ]; then
	sed -i '' 's/Merge.sublime-theme/Merge Dark.sublime-theme/g' "$sett"
else
	sed -i '' 's/Merge Dark.sublime-theme/Merge.sublime-theme/g' "$sett"
fi

################################# cht.sh

conf=$HOME/.cht.sh/cht.sh.conf

if [ "$set_dark" = true ]; then
	sed -i '' 's/style=lovelace/style=paraiso-dark/g' $conf
else
	sed -i '' 's/style=paraiso-dark/style=lovelace/g' $conf
fi
