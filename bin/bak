#!/bin/bash

# Cannot be run on Linux
case "$OSTYPE" in
    linux*)
        echo "ERROR: Script does not support Linux!"
		exit 1
esac

# echo in case run from shell
echo "Backup in progress. Please wait..."

################### Backup

cd $DOTFILES

# Brewfile dump
brew bundle dump --force
if [[ $(git diff Brewfile) ]]; then
    git add Brewfile
    git commit -m "Updated Brewfile"
fi

# Marta
cp -Rf $HOME/Library/Application\ Support/org.yanex.marta/* $DOTFILES/marta/
if [[ $(git diff marta) ]]; then
    git add marta/*
    git commit -m "Update Marta settings"
fi

# VSCode
cp -Rf $HOME/Library/Application\ Support/Code/User/settings.json $DOTFILES/vscode/
if [[ $(git diff vscode/settings.json) ]]; then
    git add vscode/settings.json
    git commit -m "Updated VSCode settings"
fi

code --list-extensions | xargs -L 1 echo code --install-extension > $DOTFILES/vscode/extensions.sh
chmod +x $DOTFILES/vscode/extensions.sh
if [[ $(git diff vscode/extensions.sh) ]]; then
    git add vscode/extensions.sh
    git commit -m "Update VSCode extensions"
fi

# push iTerm plist if there are changes
if [[ $(git diff iterm/com.googlecode.iterm2.plist) ]]; then
    git add iterm/com.googlecode.iterm2.plist
    git commit -m "Update iTerm settings"
fi

# push
echo ""
echo "Pushing to dotfiles repo:"
git push

#################### Notifications

# Displaying toast and playing sound
osascript -e 'display notification "Backup complete" with title "cron" sound name "Glass"'

# echo in case run from shell
echo ""
echo "Backup complete."
